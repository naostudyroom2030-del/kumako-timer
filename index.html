<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#69c3a1">

<!-- iOSå‘ã‘ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Kumako">
<link rel="apple-touch-icon" href="icons/icon-180.png">

<title>å­¦ç¿’ç”¨ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼ v1.4.2 nao</title>
<style>
  /* ğŸŒ¿ åŸºæœ¬ãƒ†ãƒ¼ãƒ */
  :root { --bg:#0b1220; --card:#111a2b; --text:#e8eefc; --muted:#9ab0d1; --accent:#7aa2ff; --good:#48d597; --warn:#ffb454; --bad:#ff6b6b; }
  body { margin:0; background:linear-gradient(180deg,#0b1220,#0c1323 30%,#0a0f1a); color:var(--text);
         font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; }
  .wrap{ max-width:840px; margin:32px auto; padding:16px; }
  .card{ background:var(--card); border:1px solid #1b2740; border-radius:24px; padding:20px; }
  h1{ font-size:20px; margin:0 0 12px; letter-spacing:.03em; display:flex; align-items:center; gap:8px; }
  .phase-badge{ border:1px solid #2a3a66; color:#bcd0ff; background:transparent; border-radius:999px; padding:4px 8px; font-size:13px; }
  .pill{ border:1px solid #223356; color:#cbd7ff; background:transparent; border-radius:999px; padding:4px 8px; font-size:11px; }
  .display{ font-variant-numeric:tabular-nums; font-size: clamp(48px, 9vw, 96px); text-align:center;
            border:1px solid #1d2b4a; border-radius:24px; padding:10px 16px; background:#0b1326; }
  .muted{ color:var(--muted); }
  .row{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
  .field{ background:#0b1326; border:1px solid #1d2b4a; border-radius:12px; padding:10px; }
  .field label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
  .field input{ width:100%; background:#091223; color:var(--text); border:1px solid #223356; border-radius:10px; padding:8px; }
  .controls{ margin-top:12px; position:relative; z-index:2; }
  button{ border-radius:14px; padding:10px 16px; margin:4px; cursor:pointer; font-size:14px; transition:.15s; border:1px solid #21345d; background:#142040; color:var(--text); }
  button:hover{ filter:brightness(1.06); }
  .ghost{ background:transparent }
  .success{ background:var(--good); color:#062819; border-color:#2b8c68 }
  .warn{ background:#ffe9c4; color:#4a3612; border-color:#e9c07a }

  /* ğŸƒ Minty Focus ãƒ†ãƒ¼ãƒ */
  body[data-theme="mint"]{
    --bg:#f6fff9; --card:#ffffff; --text:#2f3e37; --muted:#6b8c7c; --accent:#69c3a1; --good:#69c3a1;
    background:linear-gradient(180deg,#f6fff9,#ffffff 60%,#ffffff);
  }
  body[data-theme="mint"] .card{ border-color:#e6f6ee; box-shadow:0 16px 32px rgba(105,195,161,.08); }
  body[data-theme="mint"] .display{ background:#f9fffb; border-color:#e6f6ee; color:#24342d; }
  body[data-theme="mint"] .phase-badge{ border-color:#bfead6; color:#2f3e37; background:#eefaf4; }
  body[data-theme="mint"] .pill{ border-color:#d6f0e1; color:#2f3e37; background:#f6fff9; }
  body[data-theme="mint"] .field{ background:#fff; border-color:#d6f0e1; }
  body[data-theme="mint"] .field input{ background:#fff; border-color:#d6f0e1; color:#2f3e37; }
  body[data-theme="mint"] button{ background:#a6e6c3; border-color:#69c3a1; color:#24342d;
    box-shadow:0 2px 0 #69c3a1, 0 6px 18px rgba(105,195,161,.18); }
  body[data-theme="mint"] button:hover{ filter:brightness(1.03); box-shadow:0 3px 0 #69c3a1, 0 10px 22px rgba(105,195,161,.22); }
  body[data-theme="mint"] .muted{ color:#567a6a; }

  /* ğŸ§¸ ãã¾ã“ï¼‹å¹ãå‡ºã—ï¼ˆã‚¿ã‚¤ãƒãƒ¼ä¸‹ï¼‰ */
  .mascot { display:flex; flex-direction:column; align-items:center; gap:8px; margin:12px 0 8px; position:relative; z-index:1; }
  #kumako { width:110px; height:auto; opacity:.98; pointer-events:none; }
  .running #kumako { animation:bob 2s ease-in-out infinite; transform-origin:50% 100%; }
  @keyframes bob { 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-4px) } }
  .bubble { position:relative; max-width:520px; padding:10px 14px; border-radius:14px; background:#eefaf4; border:1px solid #d6f0e1; color:#2f3e37; font-size:14px;
            box-shadow:0 4px 14px rgba(105,195,161,.12); }
  .bubble::after{ content:""; position:absolute; top:-8px; left:calc(50% - 8px);
                  border-width:0 8px 8px 8px; border-style:solid; border-color:transparent transparent #d6f0e1 transparent; }
  .bubble::before{ content:""; position:absolute; top:-7px; left:calc(50% - 7px);
                   border-width:0 7px 7px 7px; border-style:solid; border-color:transparent transparent #eefaf4 transparent; }

  /* é€²æ—ãƒãƒ¼ */
  #bar{height:8px;border-radius:8px;background:#e6f6ee;overflow:hidden;margin:6px 2px 0}
  #barFill{height:100%;width:0%;background:#69c3a1;transition:width .2s ease}

  /* ä¼‘æ†©ãƒãƒƒã‚¸ã®è‰² */
  .breaking .phase-badge{ background:#fff8ec; border-color:#ffd9a8; color:#573d17; }

  .footer{ text-align:center; font-size:11px; color:#7d90b6; opacity:.9; margin:14px 0; }
</style>
</head>
<body data-theme="mint">
<div class="wrap">
  <div class="card" id="app">
    <h1>
      å­¦ç¿’ç”¨ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼
      <span class="phase-badge" id="phaseBadge">ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</span>
      <span class="pill">v1.4.2 nao</span>
    </h1>

    <!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -->
    <div class="display" id="display">40:00</div>
    <!-- é€²æ—ãƒãƒ¼ï¼ˆã‚¿ã‚¤ãƒãƒ¼ç›´ä¸‹ï¼‰ -->
    <div id="bar"><div id="barFill"></div></div>

    <!-- ãã¾ã“ï¼‹å¹ãå‡ºã—ï¼ˆã‚¿ã‚¤ãƒãƒ¼ã®ä¸‹ã«ä¸­å¤®ï¼‰ -->
    <div class="mascot">
      <img id="kumako" src="kumako.png" alt="ãã¾ã“">
      <div class="bubble" id="bubble">æº–å‚™OKï¼Ÿ æœ€åˆã‹ã‚‰ã„ã“ã†ï¼</div>
    </div>

    <!-- æ“ä½œ -->
    <div class="controls">
      <button id="startBtn" type="button">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="pauseBtn" type="button">ä¸€æ™‚åœæ­¢</button>
      <button id="resetBtn" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="skipBtn" type="button" class="ghost">â†’ æ¬¡ã¸</button>
    </div>

    <!-- è‡ªå‹•é€²è¡Œãƒˆã‚°ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFFï¼‰ -->
    <label class="muted" style="font-size:12px;display:inline-flex;align-items:center;gap:6px;margin-left:8px">
      <input type="checkbox" id="autoContinue">
      ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡æ›¿å¾Œã«è‡ªå‹•ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹
    </label>

    <!-- è¨­å®šï¼ˆãƒŠã‚ªä»•æ§˜ãŒåˆæœŸå€¤ï¼‰ -->
    <div class="row" style="margin-top:12px">
      <div class="field">
        <label>é›†ä¸­ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="focusMin" min="1" value="40">
      </div>
      <div class="field">
        <label>çŸ­ä¼‘æ†©ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="shortMin" min="1" value="10">
      </div>
      <div class="field">
        <label>é•·ä¼‘æ†©ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="longMin" min="1" value="20">
      </div>
      <div class="field">
        <label>é•·ä¼‘æ†©ã¾ã§ã®ã‚»ãƒƒãƒˆæ•°</label>
        <input type="number" id="setsToLong" min="2" value="4">
      </div>
    </div>

    <!-- ãƒ†ãƒ¼ãƒåˆ‡æ›¿ -->
    <div style="margin-top:12px" class="field">
      <label>ãƒ†ãƒ¼ãƒ</label>
      <select id="themeSelect">
        <option value="mint">ãƒŸãƒ³ãƒˆï¼ˆçˆ½ã‚„ã‹ï¼‰</option>
        <option value="dark">å¤œç©ºï¼ˆãƒ€ãƒ¼ã‚¯ï¼‰</option>
      </select>
    </div>

    <p class="muted" style="font-size:12px;margin-top:12px">è¨­å®šã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ã‚‚ç¶šãã¾ã™ï¼ˆç°¡æ˜“ï¼‰ã€‚</p>
  </div>
</div>

<script>
  // ========== çŠ¶æ…‹ ==========
  const $ = id => document.getElementById(id);
  const app = $('app');
  const state = {
    phase: 'focus',           // 'focus' | 'short' | 'long'
    remaining: 40*60,         // ç§’
    startTotal: 40*60,        // ãƒ•ã‚§ãƒ¼ã‚ºç·ç§’æ•°ï¼ˆãƒãƒ¼ç”¨ï¼‰
    targetTs: null,           // ç›®æ¨™æ™‚åˆ»(ms)
    timerId: null,
    setIndex: 1,              // ä½•ã‚»ãƒƒãƒˆç›®ã®çµ‚äº†ã‹ï¼ˆfocuså®Œäº†ã§+1ï¼‰
    running: false,
    fiveMinFlag: false        // æ®‹ã‚Š5åˆ†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€åº¦ã ã‘
  };

  // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
  const fmt = s => {
    s = Math.max(0, Math.floor(s));
    const m = Math.floor(s/60), ss = s%60;
    return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  };
  const say = (t)=> $('bubble').textContent = t;

  // ========== ãƒ†ãƒ¼ãƒä¿å­˜ ==========
  (function themeInit(){
    try{
      const key='pomodoro_v2';
      const saved=JSON.parse(localStorage.getItem(key)||'{}');
      const initial = saved.theme || 'mint';
      document.body.setAttribute('data-theme', initial);
      const sel=$('themeSelect');
      if(sel){
        sel.value=initial;
        sel.addEventListener('change', ()=>{
          const v=sel.value;
          document.body.setAttribute('data-theme', v);
          const cur=JSON.parse(localStorage.getItem(key)||'{}');
          cur.theme=v; localStorage.setItem(key, JSON.stringify(cur));
        });
      }
    }catch(e){}
  })();

  // ========== ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡æ›¿ ==========
  function minutesFor(phase){
    if(phase==='focus') return +$('focusMin').value || 40;
    if(phase==='short') return +$('shortMin').value || 10;
    return +$('longMin').value || 20;
  }
  function labelFor(phase){
    return phase==='focus' ? 'ãƒ•ã‚©ãƒ¼ã‚«ã‚¹' : (phase==='short'?'çŸ­ä¼‘æ†©':'é•·ä¼‘æ†©');
  }
  function setPhase(phase){
    state.phase = phase;
    state.remaining = minutesFor(phase)*60;
    state.startTotal = state.remaining;           // ãƒãƒ¼åˆæœŸåŒ–
    state.fiveMinFlag = false;
    $('display').textContent = fmt(state.remaining);
    $('phaseBadge').textContent = labelFor(phase);
    $('barFill').style.width = '0%';
    app.classList.toggle('breaking', phase!=='focus');
    if(phase==='focus') say('æº–å‚™OKï¼Ÿ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã„ã£ã¦ã¿ã‚ˆã†ï¼');
    if(phase==='short') say('ãŠæ°´ã®ã‚‚ã†ã€œ ã¡ã‚‡ã£ã¨ä¼‘æ†©â˜•');
    if(phase==='long')  say('ã‚ˆããŒã‚“ã°ã£ãŸã­ï¼ ã—ã£ã‹ã‚Šé•·ã‚ã«ä¼‘ã‚‚ã†ğŸ˜Š');
  }

  // ========== ã‚¿ã‚¤ãƒãƒ¼æ“ä½œ ==========
  function updateBar(){
    if(state.startTotal>0){
      const p = 100 * (1 - state.remaining / state.startTotal);
      $('barFill').style.width = Math.min(100, Math.max(0, p)) + '%';
    }
  }
  function tick(){
    const now = Date.now();
    state.remaining = Math.ceil((state.targetTs - now)/1000);
    $('display').textContent = fmt(state.remaining);
    updateBar();

    if(state.phase==='focus' && !state.fiveMinFlag && state.remaining === 5*60){
      say('ã‚ã¨5åˆ†ï¼ ãã®ã¾ã¾é§†ã‘æŠœã‘ã‚ˆã†ğŸ”¥'); state.fiveMinFlag = true;
    }
    if(state.remaining <= 0){
      onPhaseComplete();
      return; // â˜… å¤ã„tickã‚’çµ‚äº†
    }
  }
  function start(){
    if(state.running) return;
    state.targetTs = Date.now() + state.remaining*1000;
    state.timerId = setInterval(tick, 200);
    state.running = true;
    app.classList.add('running');
    say(state.phase==='focus' ? 'ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ã€é›†ä¸­ã‚¿ã‚¤ãƒ ï¼' : 'ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€œæ·±å‘¼å¸ğŸ«§');
    saveSettings();
  }
  // èµ°è¡Œä¸­ã®tickã‚’é™ã‹ã«æ­¢ã‚ã‚‹ï¼ˆãƒãƒ–ãƒ«æ–‡è¨€ã¯å¤‰ãˆãªã„ï¼‰
  function stopTick() {
    if (state.timerId) { clearInterval(state.timerId); state.timerId = null; }
    state.running = false;
    app.classList.remove('running');
  }
  function pause(){
    if(!state.running) return;
    stopTick();
    say('ä¸€æ™‚åœæ­¢ã€œ æ•´ãˆã¦å†é–‹ã—ã‚ˆï¼');
  }
  function reset(){
    stopTick();
    state.setIndex = 1;
    setPhase('focus');
  }

  function onPhaseComplete(force=false){
    const wasRunning = state.running; // ç›´å‰ã«èµ°ã£ã¦ã„ãŸã‹è¨˜æ†¶
    stopTick();                       // â˜…å¤ã„targetTsã‚’å¿…ãšåœæ­¢

    // æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºã¸
    if(state.phase==='focus'){
      const setsToLong = +$('setsToLong').value || 4;
      const next = (state.setIndex % setsToLong === 0) ? 'long' : 'short';
      state.setIndex += 1;
      setPhase(next);
    }else{
      setPhase('focus');
    }

    // è‡ªå‹•é€²è¡Œã®åˆ¤æ–­ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFFï¼‰
    const auto = $('autoContinue')?.checked ?? false;
    if (force || (wasRunning && auto)) {
      start();
    } else {
      $('display').textContent = fmt(state.remaining);
      say('æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã®æº–å‚™ãŒã§ããŸã‚‰ã€ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã­ğŸ§¸');
    }
  }

  // ã©ã®ãƒ•ã‚§ãƒ¼ã‚ºã§ã‚‚å¿…ãšå³æ¬¡ã¸ï¼ˆforce=trueï¼‰
  function skip(){ onPhaseComplete(true); }

  // ========== å…¥å‡ºåŠ› ==========
  function saveSettings(){
    try{
      const key='pomodoro_v2';
      const cur=JSON.parse(localStorage.getItem(key)||'{}');
      cur.focusMin=+$('focusMin').value; cur.shortMin=+$('shortMin').value;
      cur.longMin=+$('longMin').value;   cur.setsToLong=+$('setsToLong').value;
      cur.autoNext = !!$('autoContinue')?.checked; // â˜… è¿½åŠ ä¿å­˜
      localStorage.setItem(key, JSON.stringify(cur));
    }catch(e){}
  }
  (function restoreSettings(){
    try{
      const s=JSON.parse(localStorage.getItem('pomodoro_v2')||'{}');
      if(s.focusMin) $('focusMin').value = s.focusMin;
      if(s.shortMin) $('shortMin').value = s.shortMin;
      if(s.longMin)  $('longMin').value  = s.longMin;
      if(s.setsToLong) $('setsToLong').value = s.setsToLong;
      if('autoNext' in s && $('autoContinue')) $('autoContinue').checked = !!s.autoNext; // â˜… å¾©å…ƒ
    }catch(e){}
  })();

  // ========== ã‚¤ãƒ™ãƒ³ãƒˆ ==========
  $('startBtn').addEventListener('click', start);
  $('pauseBtn').addEventListener('click', pause);
  $('resetBtn').addEventListener('click', reset);
  $('skipBtn').addEventListener('click', skip);
  $('autoContinue')?.addEventListener('change', saveSettings);
  ['focusMin','shortMin','longMin','setsToLong'].forEach(id=>{
    $(id).addEventListener('change', ()=>{
      saveSettings();
      if(!state.running){
        state.remaining = minutesFor(state.phase)*60;
        state.startTotal = state.remaining; $('barFill').style.width='0%';
        $('display').textContent = fmt(state.remaining);
      }
    });
  });
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){ e.preventDefault(); state.running? pause(): start(); }
    if(e.key==='r' || e.key==='R'){ reset(); }
    if(e.key==='ArrowRight'){ skip(); }
  });

  // åˆæœŸåŒ–
  setPhase('focus'); // ãƒŠã‚ªä»•æ§˜ï¼ˆ40åˆ†ï¼‰ã§è¡¨ç¤º
</script>

<div class="footer">Pomodoro <strong>v1.4.2 nao (manual default)</strong></div>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
</script>
</body>
</html>
