<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#69c3a1">

<!-- iOSå‘ã‘ -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Kumako">
<link rel="apple-touch-icon" href="icons/icon-180.png">

<title>å­¦ç¿’ç”¨ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼ v1.5 ring</title>
<style>
  /* ğŸŒ¿ åŸºæœ¬ãƒ†ãƒ¼ãƒ */
  :root { --bg:#0b1220; --card:#111a2b; --text:#e8eefc; --muted:#9ab0d1; --accent:#7aa2ff; --good:#48d597; --warn:#ffb454; --bad:#ff6b6b; }
  body { margin:0; background:linear-gradient(180deg,#0b1220,#0c1323 30%,#0a0f1a); color:var(--text);
         font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; }
  .wrap{ max-width:840px; margin:32px auto; padding:16px; }
  .card{ background:var(--card); border:1px solid #1b2740; border-radius:24px; padding:20px; }
  h1{ font-size:20px; margin:0 0 12px; letter-spacing:.03em; display:flex; align-items:center; gap:8px; }
  .phase-badge{ border:1px solid #2a3a66; color:#bcd0ff; background:transparent; border-radius:999px; padding:4px 8px; font-size:13px; }
  .pill{ border:1px solid #223356; color:#cbd7ff; background:transparent; border-radius:999px; padding:4px 8px; font-size:11px; }
  .muted{ color:var(--muted); }

  .row{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
  .field{ background:#0b1326; border:1px solid #1d2b4a; border-radius:12px; padding:10px; }
  .field label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
  .field input{ width:100%; background:#091223; color:var(--text); border:1px solid #223356; border-radius:10px; padding:8px; }

  .controls{ margin-top:12px; position:relative; z-index:2; }
  button{ border-radius:14px; padding:10px 16px; margin:4px; cursor:pointer; font-size:14px; transition:.15s; border:1px solid #21345d; background:#142040; color:var(--text); }
  button:hover{ filter:brightness(1.06); }
  .ghost{ background:transparent }

  /* ğŸƒ Minty Focus ãƒ†ãƒ¼ãƒ */
  body[data-theme="mint"]{
    --bg:#f6fff9; --card:#ffffff; --text:#2f3e37; --muted:#6b8c7c; --accent:#69c3a1; --good:#69c3a1;
    background:linear-gradient(180deg,#f6fff9,#ffffff 60%,#ffffff);
  }
  body[data-theme="mint"] .card{ border-color:#e6f6ee; box-shadow:0 16px 32px rgba(105,195,161,.08); }
  body[data-theme="mint"] .phase-badge{ border-color:#bfead6; color:#2f3e37; background:#eefaf4; }
  body[data-theme="mint"] .pill{ border-color:#d6f0e1; color:#2f3e37; background:#f6fff9; }
  body[data-theme="mint"] .field{ background:#fff; border-color:#d6f0e1; }
  body[data-theme="mint"] .field input{ background:#fff; border-color:#d6f0e1; color:#2f3e37; }
  body[data-theme="mint"] button{ background:#a6e6c3; border-color:#69c3a1; color:#24342d;
    box-shadow:0 2px 0 #69c3a1, 0 6px 18px rgba(105,195,161,.18); }
  body[data-theme="mint"] button:hover{ filter:brightness(1.03); box-shadow:0 3px 0 #69c3a1, 0 10px 22px rgba(105,195,161,.22); }
  body[data-theme="mint"] .muted{ color:#567a6a; }

  /* ğŸ§¸ ãã¾ã“ï¼‹å¹ãå‡ºã— */
  .mascot { display:flex; flex-direction:column; align-items:center; gap:8px; margin:12px 0 8px; position:relative; z-index:1; }
  #kumako { width:110px; height:auto; opacity:.98; pointer-events:none; }
  .running #kumako { animation:bob 2s ease-in-out infinite; transform-origin:50% 100%; }
  @keyframes bob { 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-4px) } }
  .bubble { position:relative; max-width:520px; padding:10px 14px; border-radius:14px; background:#eefaf4; border:1px solid #d6f0e1; color:#2f3e37; font-size:14px;
            box-shadow:0 4px 14px rgba(105,195,161,.12); }
  .bubble::after{ content:""; position:absolute; top:-8px; left:calc(50% - 8px);
                  border-width:0 8px 8px 8px; border-style:solid; border-color:transparent transparent #d6f0e1 transparent; }
  .bubble::before{ content:""; position:absolute; top:-7px; left:calc(50% - 7px);
                   border-width:0 7px 7px 7px; border-style:solid; border-color:transparent transparent #eefaf4 transparent; }

  /* å††å½¢ã‚¿ã‚¤ãƒãƒ¼ */
  .timer-wrap{
    width:min(56vw,320px); height:min(56vw,320px);
    margin:12px auto 6px; position:relative;
  }
  .ring{ width:100%; height:100%; transform:rotate(-90deg); }
  .ring-bg{ fill:none; stroke:#e6f6ee; stroke-width:10; opacity:.7; }
  .ring-fg{ fill:none; stroke:var(--accent); stroke-width:10; stroke-linecap:round;
            stroke-dasharray: 339.292; stroke-dashoffset: 339.292; transition: stroke-dashoffset .2s ease; }
  .timer-center{
    position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
  }
  .time{ font-variant-numeric:tabular-nums; font-size: clamp(40px, 8vw, 72px); font-weight:600; color:var(--text); letter-spacing:.02em; }
  .phase-mini{ font-size:12px; color:var(--muted); margin-top:4px; }

  /* ä¼‘æ†©ãƒãƒƒã‚¸ï¼†ãƒªãƒ³ã‚°è‰² */
  .breaking .phase-badge{ background:#fff8ec; border-color:#ffd9a8; color:#573d17; }
  .breaking .ring-fg{ stroke: var(--warn); }
  @media (prefers-reduced-motion: reduce){ .ring-fg{ transition:none } }

  .footer{ text-align:center; font-size:11px; color:#7d90b6; opacity:.9; margin:14px 0; }
  /* çµ‚äº†ã‚¢ãƒ‹ãƒ¡ */
@keyframes ringPop { 0%{ stroke-width:10; filter:none; }
  45%{ stroke-width:14; filter:drop-shadow(0 0 10px rgba(105,195,161,.35)); }
  100%{ stroke-width:10; filter:none; } }
@keyframes centerPulse { 0%{ transform:scale(1); opacity:1; }
  50%{ transform:scale(1.06); opacity:1; }
  100%{ transform:scale(1); opacity:1; } }
@keyframes kumaBounce { 0%,100%{ transform:translateY(0) }
  40%{ transform:translateY(-6px) } }

.ring-fg.pop   { animation: ringPop .7s ease-out 1; }
.timer-center.pulse { animation: centerPulse .6s ease-out 1; }
#kumako.cele   { animation: kumaBounce .6s ease-out 1; }

</style>
</head>
<body data-theme="mint">
<div class="wrap">
  <div class="card" id="app">
    <h1>
      å­¦ç¿’ç”¨ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚¿ã‚¤ãƒãƒ¼
      <span class="phase-badge" id="phaseBadge">ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</span>
      <span class="pill">v1.5 ring</span>
    </h1>

    <!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºï¼ˆå††å½¢ãƒªãƒ³ã‚°ï¼‰ -->
    <div class="timer-wrap">
      <svg class="ring" viewBox="0 0 120 120" aria-hidden="true">
        <circle class="ring-bg" cx="60" cy="60" r="54" />
        <circle class="ring-fg" id="ringFg" cx="60" cy="60" r="54" />
      </svg>
      <div class="timer-center">
        <div class="time" id="display">40:00</div>
        <div class="phase-mini" id="phaseMini">ãƒ•ã‚©ãƒ¼ã‚«ã‚¹</div>
      </div>
    </div>

    <!-- ãã¾ã“ï¼‹å¹ãå‡ºã— -->
    <div class="mascot">
      <img id="kumako" src="kumako.png" alt="ãã¾ã“">
      <div class="bubble" id="bubble">æº–å‚™OKï¼Ÿ æœ€åˆã‹ã‚‰ã„ã“ã†ï¼</div>
    </div>

    <!-- æ“ä½œ -->
    <div class="controls">
      <button id="startBtn" type="button">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="pauseBtn" type="button">ä¸€æ™‚åœæ­¢</button>
      <button id="resetBtn" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
      <button id="skipBtn"  type="button" class="ghost">â†’ æ¬¡ã¸</button>
    </div>

    <!-- è‡ªå‹•é€²è¡Œãƒˆã‚°ãƒ«ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFFï¼‰ -->
    <label class="muted" style="font-size:12px;display:inline-flex;align-items:center;gap:6px;margin-left:8px">
      <input type="checkbox" id="autoContinue">
      ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡æ›¿å¾Œã«è‡ªå‹•ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹
    </label>
    <label class="muted" style="font-size:12px;display:inline-flex;align-items:center;gap:6px;margin-left:12px">
  <input type="checkbox" id="soundOn" checked> ã‚µã‚¦ãƒ³ãƒ‰
</label>
<label class="muted" style="font-size:12px;display:inline-flex;align-items:center;gap:6px;margin-left:12px">
  <input type="checkbox" id="vibrateOn"> ãƒã‚¤ãƒ–
</label>

    <!-- è¨­å®šï¼ˆãƒŠã‚ªä»•æ§˜ãŒåˆæœŸå€¤ï¼‰ -->
    <div class="row" style="margin-top:12px">
      <div class="field">
        <label>é›†ä¸­ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="focusMin" min="1" value="40">
      </div>
      <div class="field">
        <label>çŸ­ä¼‘æ†©ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="shortMin" min="1" value="10">
      </div>
      <div class="field">
        <label>é•·ä¼‘æ†©ï¼ˆåˆ†ï¼‰</label>
        <input type="number" id="longMin" min="1" value="20">
      </div>
      <div class="field">
        <label>é•·ä¼‘æ†©ã¾ã§ã®ã‚»ãƒƒãƒˆæ•°</label>
        <input type="number" id="setsToLong" min="2" value="4">
      </div>
    </div>

    <!-- ãƒ†ãƒ¼ãƒåˆ‡æ›¿ -->
    <div style="margin-top:12px" class="field">
      <label>ãƒ†ãƒ¼ãƒ</label>
      <select id="themeSelect">
        <option value="mint">ãƒŸãƒ³ãƒˆï¼ˆçˆ½ã‚„ã‹ï¼‰</option>
        <option value="dark">å¤œç©ºï¼ˆãƒ€ãƒ¼ã‚¯ï¼‰</option>
      </select>
    </div>

    <p class="muted" style="font-size:12px;margin-top:12px">è¨­å®šã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ã‚‚ç¶šãã¾ã™ï¼ˆç°¡æ˜“ï¼‰ã€‚</p>
  </div>
</div>

<script>
  // ========== å‚ç…§ ==========
  const $ = id => document.getElementById(id);
  const app = $('app');

  // å††å½¢ãƒªãƒ³ã‚°ç”¨
  const R = 54;
  const CIRC = 2 * Math.PI * R; // 339.292...
  const ringEl   = $('ringFg');
  const phaseMini= $('phaseMini');

  // ========== çŠ¶æ…‹ ==========
  const state = {
    phase: 'focus',           // 'focus' | 'short' | 'long'
    remaining: 40*60,         // ç§’
    startTotal: 40*60,        // ãƒ•ã‚§ãƒ¼ã‚ºç·ç§’æ•°ï¼ˆãƒªãƒ³ã‚°ç”¨ï¼‰
    targetTs: null,           // ç›®æ¨™æ™‚åˆ»(ms)
    timerId: null,
    setIndex: 1,              // focuså®Œäº†ã§+1
    running: false,
    fiveMinFlag: false
  };

  // ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
  const fmt = s => {
    s = Math.max(0, Math.floor(s));
    const m = Math.floor(s/60), ss = s%60;
    return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  };
  const say = (t)=> $('bubble').textContent = t;

  // ========== ãƒ†ãƒ¼ãƒä¿å­˜ ==========
  (function themeInit(){
    try{
      const key='pomodoro_v2';
      const saved=JSON.parse(localStorage.getItem(key)||'{}');
      const initial = saved.theme || 'mint';
      document.body.setAttribute('data-theme', initial);
      const sel=$('themeSelect');
      if(sel){
        sel.value=initial;
        sel.addEventListener('change', ()=>{
          const v=sel.value;
          document.body.setAttribute('data-theme', v);
          const cur=JSON.parse(localStorage.getItem(key)||'{}');
          cur.theme=v; localStorage.setItem(key, JSON.stringify(cur));
        });
      }
    }catch(e){}
  })();

  // ========== ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡æ›¿ ==========
  function minutesFor(phase){
    if(phase==='focus') return +$('focusMin').value || 40;
    if(phase==='short') return +$('shortMin').value || 10;
    return +$('longMin').value || 20;
  }
  function labelFor(phase){
    return phase==='focus' ? 'ãƒ•ã‚©ãƒ¼ã‚«ã‚¹' : (phase==='short'?'çŸ­ä¼‘æ†©':'é•·ä¼‘æ†©');
  }
  function setPhase(phase){
    state.phase = phase;
    state.remaining = minutesFor(phase)*60;
    state.startTotal = state.remaining;
    state.fiveMinFlag = false;

    $('display').textContent = fmt(state.remaining);
    $('phaseBadge').textContent = labelFor(phase);
    if (phaseMini) phaseMini.textContent = labelFor(phase);

    // ãƒªãƒ³ã‚°åˆæœŸåŒ–ï¼ˆ0%è¡¨ç¤ºï¼æœªé€²æ—ï¼‰
    if (ringEl) ringEl.style.strokeDashoffset = String(CIRC);

    // ä¼‘æ†©æ™‚ã®è¦‹ãŸç›®
    app.classList.toggle('breaking', phase!=='focus');

    if(phase==='focus') say('æº–å‚™OKï¼Ÿ é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ã„ã£ã¦ã¿ã‚ˆã†ï¼');
    if(phase==='short') say('ãŠæ°´ã®ã‚‚ã†ã€œ ã¡ã‚‡ã£ã¨ä¼‘æ†©â˜•');
    if(phase==='long')  say('ã‚ˆããŒã‚“ã°ã£ãŸã­ï¼ ã—ã£ã‹ã‚Šé•·ã‚ã«ä¼‘ã‚‚ã†ğŸ˜Š');
  }

  // ========== ã‚¿ã‚¤ãƒãƒ¼æ“ä½œ ==========
  function updateRing(){
    if(state.startTotal>0 && ringEl){
      const progress = 1 - (state.remaining / state.startTotal); // 0â†’1
      const clamped = Math.min(1, Math.max(0, progress));
      ringEl.style.strokeDashoffset = String(CIRC * (1 - clamped));
    }
  }
  function tick(){
    const now = Date.now();
    state.remaining = Math.ceil((state.targetTs - now)/1000);
    $('display').textContent = fmt(state.remaining);
    updateRing();

    if(state.phase==='focus' && !state.fiveMinFlag && state.remaining === 5*60){
      say('ã‚ã¨5åˆ†ï¼ ãã®ã¾ã¾é§†ã‘æŠœã‘ã‚ˆã†ğŸ”¥'); state.fiveMinFlag = true;
    }
    if(state.remaining <= 0){
      onPhaseComplete();
      return; // å¤ã„tickçµ‚äº†
    }
  }
  function start(){
    ensureAudio(); // â†è¿½åŠ ï¼šiOSã§ã®åˆå›å†ç”Ÿè¨±å¯
    if(state.running) return;
    state.targetTs = Date.now() + state.remaining*1000;
    state.timerId = setInterval(tick, 200);
    state.running = true;
    app.classList.add('running');
    say(state.phase==='focus' ? 'ã„ã£ã¦ã‚‰ã£ã—ã‚ƒã„ã€é›†ä¸­ã‚¿ã‚¤ãƒ ï¼' : 'ãƒªãƒ©ãƒƒã‚¯ã‚¹ã€œæ·±å‘¼å¸ğŸ«§');
    saveSettings();
  }
  function stopTick() {
    if (state.timerId) { clearInterval(state.timerId); state.timerId = null; }
    state.running = false;
    app.classList.remove('running');
  }
  function pause(){
    if(!state.running) return;
    stopTick();
    say('ä¸€æ™‚åœæ­¢ã€œ æ•´ãˆã¦å†é–‹ã—ã‚ˆï¼');
  }
  function reset(){
    stopTick();
    state.setIndex = 1;
    setPhase('focus');
  }
function onPhaseComplete(force=false){
  const wasRunning = state.running;
  stopTick();

  // æ¬¡ãƒ•ã‚§ãƒ¼ã‚ºæ±ºå®š
  let nextPhase;
  if(state.phase==='focus'){
    const setsToLong = +$('setsToLong').value || 4;
    nextPhase = (state.setIndex % setsToLong === 0) ? 'long' : 'short';
    state.setIndex += 1;
  } else {
    nextPhase = 'focus';
  }
  setPhase(nextPhase);

  // ğŸ”” ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡æ›¿æ™‚ã®ã‚µã‚¦ãƒ³ãƒ‰ï¼†ã‚¢ãƒ‹ãƒ¡
  playChime(nextPhase === 'focus' ? 'toFocus' : 'toBreak');
  buzz();
  celebrateOnce();

  // è‡ªå‹•ã‚¹ã‚¿ãƒ¼ãƒˆåˆ¤å®š
  const auto = $('autoContinue')?.checked ?? false;
  if (force || (wasRunning && auto)) {
    start();
  } else {
    $('display').textContent = fmt(state.remaining);
    say('æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã®æº–å‚™ãŒã§ããŸã‚‰ã€ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã­ğŸ§¸');
  }
}

  function skip(){ onPhaseComplete(true); }

  // ========== å…¥å‡ºåŠ› ==========
  function saveSettings(){
    try{
      const key='pomodoro_v2';
      const cur=JSON.parse(localStorage.getItem(key)||'{}');
      cur.focusMin=+$('focusMin').value; cur.shortMin=+$('shortMin').value;
      cur.longMin=+$('longMin').value;   cur.setsToLong=+$('setsToLong').value;
      cur.autoNext = !!$('autoContinue')?.checked;
      cur.soundOn   = !!$('soundOn')?.checked;
      cur.vibrateOn = !!$('vibrateOn')?.checked;
      localStorage.setItem(key, JSON.stringify(cur));
    }catch(e){}
  }
  (function restoreSettings(){
    try{
      const s=JSON.parse(localStorage.getItem('pomodoro_v2')||'{}');
      if(s.focusMin) $('focusMin').value = s.focusMin;
      if(s.shortMin) $('shortMin').value = s.shortMin;
      if(s.longMin)  $('longMin').value  = s.longMin;
      if(s.setsToLong) $('setsToLong').value = s.setsToLong;
      if('autoNext' in s && $('autoContinue')) $('autoContinue').checked = !!s.autoNext;
      if('soundOn'   in s && $('soundOn'))   $('soundOn').checked   = !!s.soundOn;
      if('vibrateOn' in s && $('vibrateOn')) $('vibrateOn').checked = !!s.vibrateOn;
    }catch(e){}
  })();

  // ========== ã‚¤ãƒ™ãƒ³ãƒˆ ==========
  $('startBtn').addEventListener('click', start);
  $('pauseBtn').addEventListener('click', pause);
  $('resetBtn').addEventListener('click', reset);
  $('skipBtn').addEventListener('click', skip);
  $('autoContinue')?.addEventListener('change', saveSettings);
  ['focusMin','shortMin','longMin','setsToLong'].forEach(id=>{
    $(id).addEventListener('change', ()=>{
      saveSettings();
      if(!state.running){
        state.remaining = minutesFor(state.phase)*60;
        state.startTotal = state.remaining;
        $('display').textContent = fmt(state.remaining);
        if (ringEl) ringEl.style.strokeDashoffset = String(CIRC);
      }
    });
  });
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){ e.preventDefault(); state.running? pause(): start(); }
    if(e.key==='r' || e.key==='R'){ reset(); }
    if(e.key==='ArrowRight'){ skip(); }
  });

  // åˆæœŸåŒ–
  setPhase('focus');
</script>

<div class="footer">Pomodoro <strong>v1.5 ring (manual default)</strong></div>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
 
// ====== ãã¾ã“ã‚·ãƒ³ã‚»ï¼ˆWebAudioï¼‰ ======
let audioCtx = null;
function ensureAudio() {
  try {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
  } catch (e) {}
}

// å˜éŸ³ã‚’é³´ã‚‰ã™å°ã•ãªé–¢æ•°ï¼ˆADSR + ç°¡æ˜“ãƒ•ã‚£ãƒ«ã‚¿ + ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ï¼‰
function playNote({freq=440, t=0, dur=0.25, type='sine', gain=0.2, bend=0, lpStart=14000, lpEnd=8000}) {
  if (!audioCtx) ensureAudio();
  if (!audioCtx) return;

  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  const f = audioCtx.createBiquadFilter();
  o.type = type;
  o.frequency.value = freq;

  // ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰ï¼ˆã»ã‚“ã®å°‘ã—ã ã‘ä¸Šæ˜‡/ä¸‹é™ã•ã›ã¦â€œãã‚…ã‚‹ã£â€æ„Ÿï¼‰
  if (bend !== 0) {
    o.frequency.setValueAtTime(freq, audioCtx.currentTime + t);
    o.frequency.linearRampToValueAtTime(freq * (1 + bend), audioCtx.currentTime + t + dur * 0.9);
  }

  // ãƒ­ãƒ¼ãƒ‘ã‚¹ã§ã‚„ã•ã—ã„ä¸¸ã¿
  f.type = 'lowpass';
  f.frequency.setValueAtTime(lpStart, audioCtx.currentTime + t);
  f.frequency.linearRampToValueAtTime(lpEnd, audioCtx.currentTime + t + dur);

  // ADSRï¼ˆãµã‚ã£ã¨å‡ºã¦ã™ã£ã¨æ¶ˆãˆã‚‹ï¼‰
  const a = 0.015, d = 0.06, s = 0.55, r = 0.12;
  const t0 = audioCtx.currentTime + t;
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.linearRampToValueAtTime(gain, t0 + a);
  g.gain.linearRampToValueAtTime(gain * s, t0 + a + d);
  g.gain.linearRampToValueAtTime(0.0001, t0 + dur + r);

  // ã»ã‚“ã®å°‘ã—ã®ã‚¹ãƒ†ãƒ¬ã‚ªå¹…ï¼ˆå·¦å³ã«è–„ãæ•£ã‚‰ã™ï¼‰
  const p = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : null;
  if (p) p.pan.value = (Math.random() * 0.6 - 0.3);

  // ã¡ã‚‡ã„æ®‹éŸ¿ï¼šãƒ‡ã‚£ãƒ¬ã‚¤+ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®è¶…ãƒ©ã‚¤ãƒˆç‰ˆ
  const delay = audioCtx.createDelay(0.4);
  delay.delayTime.value = 0.14;
  const fb = audioCtx.createGain(); fb.gain.value = 0.18;
  delay.connect(fb); fb.connect(delay);

  // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  o.connect(g);
  g.connect(f);
  f.connect(delay);
  f.connect(audioCtx.destination);
  delay.connect(audioCtx.destination);

  o.start(t0);
  o.stop(t0 + dur + 0.4);
}

// ã‹ã‚ã„ã„2å±¤éŸ³ï¼šåŸºæœ¬éŸ³ï¼‹ã¡ã‚‡ã„ä¸Šã®å€éŸ³ã‚’è–„ãé‡ã­ã‚‹
function cuteTone({freq, t, dur, warm=false}) {
  playNote({freq, t, dur, type: warm ? 'triangle' : 'sine', gain: 0.18, bend: warm ? -0.01 : 0.012, lpStart: warm?12000:14000, lpEnd: warm?6000:9000});
  playNote({freq: freq*1.999, t, dur: dur*0.85, type: 'sine', gain: 0.07, bend: 0.006, lpStart: 12000, lpEnd: 9000});
}

// ãã¾ã“ãƒãƒ£ã‚¤ãƒ æœ¬ä½“ï¼ˆF1ã‚¹ã‚¿ãƒ¼ãƒˆé¢¨ï¼‹ä¸Šæ˜‡ãƒãƒ£ã‚¤ãƒ ï¼‰
function kumakoChime(kind){ // 'toBreak'ï¼ˆé›†ä¸­â†’ä¼‘æ†©ï¼‰ / 'toFocus'ï¼ˆä¼‘æ†©â†’é›†ä¸­ï¼‰
  if (!$('soundOn')?.checked) return;
  ensureAudio(); if (!audioCtx) return;

  // éŸ³éšè¨­å®š
  const A4=440, B4=494, C5=523.25, D5=587.33, E5=659.25, G5=783.99, A5=880;

  if (kind === 'toFocus') {
    // ğŸ’¥ F1ã‚¨ãƒ³ãƒˆãƒªãƒ¼é¢¨ï¼šä½â†’ä¸­â†’é«˜ã€ã†ã­ã‚‹æ„Ÿã˜ã§æ°—åˆï¼
    cuteTone({freq: A4, t: 0.00, dur: .22, warm:true});     // ä½ãæ§‹ãˆã‚‹
    cuteTone({freq: D5, t: 0.18, dur: .22, warm:false});    // ã‚¨ãƒ³ã‚¸ãƒ³ä¸ŠãŒã‚‹
    cuteTone({freq: G5, t: 0.36, dur: .30, warm:false});    // ã‚¹ã‚¿ãƒ¼ãƒˆï¼ğŸï¸ğŸ’¨
  } else {
    // âœ¨ ä¸Šæ˜‡ãƒãƒ£ã‚¤ãƒ ï¼šã‚„ã‚ã‚‰ã‹ãé«˜éŸ³ã¸æŠœã‘ã¦ã„ã
    cuteTone({freq: E5, t: 0.00, dur: .18});
    cuteTone({freq: G5, t: 0.18, dur: .20});
    cuteTone({freq: A5, t: 0.36, dur: .25});
  }
}


// æ—§ playChime ã‚’ã“ã®é–¢æ•°ã«ç½®æ›
function playChime(kind){
  kumakoChime(kind);
}

// ãƒã‚¤ãƒ–ï¼ˆä»»æ„ï¼‰
function buzz() {
  if ($('vibrateOn')?.checked && 'vibrate' in navigator) {
    navigator.vibrate([60,30,60]);
  }
}


// ======= è¦–è¦šã‚¢ãƒ‹ãƒ¡ =======
function celebrateOnce() {
  const center = document.querySelector('.timer-center');
  const ring   = $('ringFg');
  const kuma   = $('kumako');
  if (ring)   { ring.classList.add('pop');   setTimeout(()=>ring.classList.remove('pop'), 700); }
  if (center) { center.classList.add('pulse'); setTimeout(()=>center.classList.remove('pulse'), 600); }
  if (kuma)   { kuma.classList.add('cele');  setTimeout(()=>kuma.classList.remove('cele'), 600); }
}

</script>
</body>
</html>
